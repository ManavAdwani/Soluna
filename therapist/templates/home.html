<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Soluna - Your AI Therapist</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism-tomorrow.min.css" rel="stylesheet">
  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#4338ca">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(99, 102, 241, 0.5);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(99, 102, 241, 0.7);
    }

    /* Glassmorphism Utilities */
    .glass {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .glass-dark {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.5);
    }

    .message-enter {
      animation: fadeIn 0.3s ease-out forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Loading Dots Animation */
    .dot-flashing {
      position: relative;
      width: 6px;
      height: 6px;
      border-radius: 5px;
      background-color: #6366f1;
      color: #6366f1;
      animation: dot-flashing 1s infinite linear alternate;
      animation-delay: 0.5s;
    }

    .dot-flashing::before,
    .dot-flashing::after {
      content: '';
      display: inline-block;
      position: absolute;
      top: 0;
    }

    .dot-flashing::before {
      left: -10px;
      width: 6px;
      height: 6px;
      border-radius: 5px;
      background-color: #6366f1;
      color: #6366f1;
      animation: dot-flashing 1s infinite alternate;
      animation-delay: 0s;
    }

    .dot-flashing::after {
      left: 10px;
      width: 6px;
      height: 6px;
      border-radius: 5px;
      background-color: #6366f1;
      color: #6366f1;
      animation: dot-flashing 1s infinite alternate;
      animation-delay: 1s;
    }

    @keyframes dot-flashing {
      0% {
        background-color: #6366f1;
      }

      50%,
      100% {
        background-color: rgba(99, 102, 241, 0.2);
      }
    }

    /* --- Voice Mode Orb Animation --- */
    .orb-container {
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 200px;
      height: 200px;
    }

    .orb {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.8), rgba(99, 102, 241, 0.4));
      box-shadow: 0 0 40px rgba(99, 102, 241, 0.6), inset 0 0 20px rgba(255, 255, 255, 0.5);
      position: relative;
      z-index: 10;
      transition: all 0.5s ease;
    }

    /* States */
    .orb.listening {
      animation: breath 3s infinite ease-in-out;
    }

    .orb.processing {
      animation: spin 2s infinite linear;
      background: radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.9), rgba(167, 139, 250, 0.6));
    }

    .orb.speaking {
      animation: pulse-speak 1s infinite ease-in-out;
      box-shadow: 0 0 60px rgba(139, 92, 246, 0.8);
    }

    .orb-ring {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.3);
      opacity: 0;
      transform: scale(0.8);
    }

    .orb.listening~.orb-ring {
      animation: ripple 2s infinite ease-out;
    }

    @keyframes breath {

      0%,
      100% {
        transform: scale(1);
        box-shadow: 0 0 40px rgba(99, 102, 241, 0.6);
      }

      50% {
        transform: scale(1.1);
        box-shadow: 0 0 60px rgba(99, 102, 241, 0.8);
      }
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg) scale(0.9);
      }

      100% {
        transform: rotate(360deg) scale(0.9);
      }
    }

    @keyframes pulse-speak {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.2);
      }
    }

    @keyframes ripple {
      0% {
        transform: scale(0.8);
        opacity: 0.6;
        border-color: rgba(99, 102, 241, 0.5);
      }

      100% {
        transform: scale(2);
        opacity: 0;
        border-color: transparent;
      }
    }

    /* Toggle Switch Animation */
    input:checked~.toggle-bg {
      background-color: #8b5cf6;
      /* Indigo-500 */
    }

    input:checked~.dot {
      transform: translateX(100%);
    }
  </style>
</head>

<body
  class="bg-gradient-to-br from-indigo-50 via-purple-50 to-blue-50 h-screen flex flex-col font-sans text-gray-800 overflow-hidden relative">

  <!-- Voice Mode Overlay -->
  <div id="voice-overlay"
    class="fixed inset-0 z-50 bg-gradient-to-br from-indigo-50 via-purple-50 to-blue-50 flex flex-col items-center justify-center transition-opacity duration-500 opacity-0 pointer-events-none hidden">

    <!-- Close Button -->
    <button id="close-voice-btn"
      class="absolute top-6 right-6 text-gray-600 hover:text-gray-900 bg-white/50 hover:bg-white/80 p-3 rounded-full shadow-lg transition transform hover:scale-105">
      <i class="fas fa-times text-xl"></i>
    </button>

    <!-- Orb Visualizer -->
    <div class="flex-1 flex flex-col items-center justify-center w-full">
      <div class="orb-container">
        <div id="orb" class="orb listening"></div>
        <div class="orb-ring"></div>
        <div class="orb-ring" style="animation-delay: 0.6s"></div>
        <div class="orb-ring" style="animation-delay: 1.2s"></div>
      </div>

      <!-- Status Text -->
      <h2 id="voice-status" class="mt-12 text-2xl font-semibold text-indigo-900 tracking-wide">Soluna is listening...
      </h2>
      <p id="voice-subtext" class="mt-2 text-indigo-600/80 text-sm font-medium">Speak naturally</p>
    </div>

    <!-- Controls -->
    <div class="pb-16 flex gap-6">
      <button id="mute-btn"
        class="w-16 h-16 rounded-full bg-white shadow-xl flex items-center justify-center text-gray-600 hover:text-red-500 hover:bg-red-50 transition duration-300">
        <i id="mute-icon" class="fas fa-microphone text-2xl"></i>
      </button>
    </div>
  </div>


  <!-- Navbar -->
  <nav
    class="w-full glass shadow-sm z-20 px-4 md:px-6 py-4 flex justify-between items-center fixed top-0 transition-all duration-300">
    <div class="flex items-center gap-4">
      <button id="sidebar-toggle"
        class="text-gray-600 hover:text-indigo-600 focus:outline-none transition transform hover:scale-105">
        <i class="fas fa-bars text-xl"></i>
      </button>
      <div class="flex items-center gap-2">
        <span class="text-2xl">üåô</span>
        <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600">
          Soluna
        </h1>
      </div>
    </div>
    <!-- ... Navbar Logic ... -->
    <button id="logout-btn"
      class="bg-white hover:bg-red-50 text-gray-600 hover:text-red-500 border border-gray-200 px-3 py-2 md:px-4 md:py-2 rounded-full text-xs md:text-sm font-medium transition duration-200 flex items-center gap-2 shadow-sm">
      <i class="fas fa-sign-out-alt"></i> <span class="hidden md:inline">Logout</span>
    </button>
  </nav>

  <!-- Content Wrapper -->
  <div class="flex flex-1 h-full pt-16 overflow-hidden relative">

    <!-- Sidebar (History) -->
    <aside id="sidebar-panel"
      class="absolute md:relative w-72 h-full z-50 glass-dark border-r border-white/20 transform transition-transform duration-300 -translate-x-full md:translate-x-0 flex flex-col pb-20 md:pb-0">
      <div class="p-4 flex flex-col gap-4 border-b border-white/10">
        <!-- Panic SOS Button -->
        <a href="/panic/"
          class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg shadow-red-500/30 transition transform hover:scale-[1.02] flex items-center justify-center gap-2 group mb-2 animate-pulse">
          <i class="fas fa-heartbeat"></i> <span>SOS / Panic</span>
        </a>

        <!-- Main Action -->
        <button onclick="startNewChat()"
          class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white font-medium py-3 px-4 rounded-xl shadow-lg shadow-indigo-500/20 transition transform hover:scale-[1.02] flex items-center justify-center gap-2 group">
          <i class="fas fa-plus transition-transform group-hover:rotate-90"></i> <span>New Chat</span>
        </button>

        <!-- Navigation Menu -->
        <nav class="space-y-1">
          <a href="/dashboard/"
            class="flex items-center gap-3 p-3 rounded-xl hover:bg-white/50 text-indigo-700 font-medium transition group">
            <div
              class="w-8 h-8 rounded-lg bg-indigo-100 flex items-center justify-center group-hover:bg-indigo-600 transition">
              <i class="fas fa-chart-pie text-indigo-500 group-hover:text-white transition"></i>
            </div>
            <span>Analytics</span>
          </a>

          <a href="/journal/"
            class="flex items-center gap-3 p-3 rounded-xl hover:bg-white/50 text-indigo-700 font-medium transition group">
            <div
              class="w-8 h-8 rounded-lg bg-indigo-100 flex items-center justify-center group-hover:bg-indigo-600 transition">
              <i class="fas fa-book-open text-indigo-500 group-hover:text-white transition"></i>
            </div>
            <span>Journal</span>
          </a>
        </nav>
      </div>

      <div class="flex-1 overflow-y-auto px-3 pb-4 space-y-2 mt-2" id="conversation-list">
        <!-- History Items will be injected here -->
        <div class="text-center text-gray-500 text-sm mt-4">Loading history...</div>
      </div>

      <!-- Sidebar Footer (Gen Z Toggle) -->
      <div class="mt-auto p-4 border-t border-white/10 bg-white/5 backdrop-blur-sm">
        <div class="flex items-center justify-between bg-white/40 p-3 rounded-xl border border-white/20 shadow-sm">
          <div class="flex items-center gap-2 text-indigo-900 text-sm font-semibold">
            <i class="fas fa-magic text-indigo-500"></i>
            <span>Gen Z Mode</span>
          </div>
          <!-- Switch -->
          <label for="genz-switch" class="flex items-center cursor-pointer relative">
            <input type="checkbox" id="genz-switch" class="sr-only">
            <div
              class="w-10 h-6 bg-gray-300 rounded-full border border-gray-200 shadow-inner toggle-bg transition duration-300">
            </div>
            <div
              class="dot absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition duration-300 shadow-md transform">
            </div>
          </label>
        </div>
      </div>
    </aside>

    <!-- Main Chat Area -->
    <main
      class="flex-1 flex flex-col h-full relative bg-gradient-to-br from-indigo-50/50 via-purple-50/50 to-blue-50/50"
      id="main-content">

      <!-- Scrollable Container -->
      <div id="scroll-container" class="flex-1 overflow-y-auto w-full relative custom-scrollbar flex flex-col">
        <!-- Chat Content (Centered) -->
        <div id="chat-box" class="w-full max-w-3xl mx-auto p-4 md:p-6 pb-4 flex flex-col gap-6 flex-1">

          <!-- Start Message (Vertically Centered) -->
          <div id="start-message"
            class="flex-1 flex flex-col items-center justify-center text-gray-400 opacity-90 min-h-[50vh]">
            <div
              class="w-24 h-24 bg-white/80 rounded-full shadow-lg flex items-center justify-center mb-6 animate-pulse-slow">
              <i class="fas fa-comments text-5xl text-indigo-500"></i>
            </div>
            <h2 class="text-2xl font-semibold text-gray-700 mb-2">Welcome to Soluna</h2>
            <p class="text-base text-gray-500">Your caring AI companion. How can I help?</p>
          </div>
          <!-- Messages will be injected here -->

        </div>
      </div>

      <!-- Controls Area (Centered) -->
      <div class="w-full z-10 bg-gradient-to-t from-white/10 to-transparent">
        <div class="max-w-3xl mx-auto px-4 pb-6 pt-2 flex flex-col gap-3">

          <!-- Voice Mode Toggle (Separate & Prominent) -->
          <div class="flex justify-center">
            <button id="talk-btn"
              class="group bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-medium py-2.5 px-6 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-0.5 flex items-center gap-2.5">
              <span class="relative flex h-3 w-3">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-white opacity-75"></span>
                <span class="relative inline-flex rounded-full h-3 w-3 bg-white"></span>
              </span>
              <span>Talk to Soluna (Voice Mode)</span>
            </button>
          </div>

          <!-- Input Bar -->
          <div
            class="bg-white rounded-2xl shadow-xl p-2 md:p-3 flex items-end gap-2 border border-gray-100 ring-1 ring-black/5 focus-within:ring-indigo-500/20 transition-all">
            <textarea id="user-prompt" rows="1" placeholder="Message Soluna..."
              class="flex-1 bg-transparent text-gray-700 placeholder-gray-400 p-2 ml-1 rounded-lg focus:outline-none resize-none max-h-32 leading-relaxed"
              oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>

            <button id="mic-btn"
              class="p-2.5 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-full transition duration-200"
              title="Dictation">
              <i class="fas fa-microphone-alt text-lg"></i>
            </button>

            <button id="send-btn"
              class="bg-indigo-600 hover:bg-indigo-700 text-white p-2.5 rounded-xl shadow-md transition duration-200 transform hover:scale-105 flex items-center justify-center w-10 h-10"
              title="Send">
              <i class="fas fa-arrow-up"></i>
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- JavaScript -->
  <script>
    // --- Core Chat Logic ---
    let currentConversationId = null;
    const sidebarPanel = document.getElementById("sidebar-panel");
    const sidebarToggle = document.getElementById("sidebar-toggle");

    // Toggle Sidebar
    sidebarToggle.addEventListener("click", () => {
      // Toggle the hidden state
      sidebarPanel.classList.toggle("-translate-x-full");

      // Improve Logic: If we just hid it (added -translate...), we must REMOVE the desktop override
      if (sidebarPanel.classList.contains("-translate-x-full")) {
        sidebarPanel.classList.remove("md:translate-x-0");
      } else {
        // If we just showed it, we should Ensure the desktop override is back (or just trust the removal of translate-x-full)
        // Actually, adding md:translate-x-0 ensures it stays visible if screen resizes
        sidebarPanel.classList.add("md:translate-x-0");
      }
    });

    async function loadConversations() {
      const res = await fetch("/api/conversations/");
      const data = await res.json();
      const list = document.getElementById("conversation-list");
      list.innerHTML = "";
      data.conversations.forEach(conv => {
        const div = document.createElement("div");
        // Styling: group for hover effect on delete button
        div.className = "group p-3 rounded-xl hover:bg-white/10 cursor-pointer transition flex items-center justify-between gap-2 text-white/90 text-sm border border-transparent hover:border-white/5";

        // Title span
        const titleSpan = document.createElement("span");
        titleSpan.className = "truncate flex-1";
        titleSpan.innerText = conv.title;
        titleSpan.onclick = () => {
          loadSession(conv.id);
          // On mobile, close sidebar after selection
          if (window.innerWidth < 768) {
            sidebarPanel.classList.add("-translate-x-full");
          }
        };

        // Delete Button
        const delBtn = document.createElement("button");
        delBtn.className = "text-gray-400 hover:text-red-400 opacity-0 group-hover:opacity-100 transition p-1 hover:bg-white/10 rounded";
        delBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
        delBtn.onclick = (e) => {
          e.stopPropagation(); // prevent triggering loadSession
          deleteConversation(conv.id);
        };

        div.appendChild(titleSpan);
        div.appendChild(delBtn);
        list.appendChild(div);
      });
    }

    async function deleteConversation(id) {
      if (!confirm("Are you sure you want to delete this chat?")) return;

      const res = await fetch(`/api/conversations/${id}/delete/`, {
        method: "DELETE",
        headers: { "X-CSRFToken": getCSRFToken() }
      });

      if (res.ok) {
        // If deleting current, clear view
        if (currentConversationId === id) {
          startNewChat();
        }
        loadConversations();
      } else {
        alert("Failed to delete conversation.");
      }
    }

    async function loadSession(id) {
      currentConversationId = id;
      document.getElementById("chat-box").innerHTML = ""; // Clear current
      const res = await fetch(`/api/conversations/${id}/`);
      if (res.ok) {
        const data = await res.json();
        if (document.getElementById("start-message")) document.getElementById("start-message").style.display = "none"; // Ensure hidden

        data.messages.forEach(msg => {
          appendMessage(msg.content, msg.role);
        });
        // Close sidebar on mobile if we had one
      }
    }

    function startNewChat() {
      currentConversationId = null;
      const chatBox = document.getElementById("chat-box");
      chatBox.innerHTML = `
      <div id="start-message" class="flex flex-col items-center justify-center h-full text-gray-400 opacity-80 mt-10">
        <i class="fas fa-comments text-6xl mb-4 text-indigo-200"></i>
        <p class="text-lg">Start a conversation with Soluna</p>
        <p class="text-sm">Your caring AI companion</p>
      </div>`;
    }

    // Load on start
    loadConversations();

    function getCSRFToken() {
      const cookieValue = document.cookie
        .split("; ")
        .find((row) => row.startsWith("csrftoken="))
        ?.split("=")[1];
      return cookieValue;
    }

    document.getElementById("send-btn").addEventListener("click", async function () {
      sendMessage();
    });

    // Handle Enter key
    const textarea = document.getElementById("user-prompt");
    textarea.addEventListener("keydown", function (e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // --- Gen Z Mode Logic (Sidebar Switch) ---
    // Note: The logic is now handled by the inline script near the sidebar footer.
    // We keep the variable initialization here for global scope if needed, 
    // but the event listener is attached directly to the new switch element below.

    // Ensure global variable exists for other functions
    if (typeof isGenZMode === 'undefined') {
      var isGenZMode = localStorage.getItem('genzMode') === 'true';
    }

    // --- Gen Z Switch Event Listener ---
    const genZSwitch = document.getElementById("genz-switch");
    if (genZSwitch) {
      // Apply initial state
      if (isGenZMode) {
        genZSwitch.checked = true;
      }

      // Listen for changes
      genZSwitch.addEventListener("change", (e) => {
        isGenZMode = e.target.checked;
        localStorage.setItem('genzMode', isGenZMode);
        console.log("Gen Z Mode toggled:", isGenZMode);
      });
    }

    async function sendMessage(text = null) {
      const promptInput = document.getElementById("user-prompt");
      const prompt = text || promptInput.value.trim();
      const chatBox = document.getElementById("chat-box");
      const startMessage = document.getElementById("start-message");

      if (!prompt) return;

      if (startMessage) startMessage.style.display = "none";

      // User Message
      appendMessage(prompt, 'user');

      if (!text) { // Clear input only if entered via text
        promptInput.value = "";
        promptInput.style.height = 'auto';
      }

      // Loading Indicator
      const loaderId = 'loader-' + Date.now();
      const loaderDiv = document.createElement("div");
      loaderDiv.id = loaderId;
      loaderDiv.className = "flex justify-start mb-4";
      loaderDiv.innerHTML = `
                <div class="bg-white text-gray-800 p-4 rounded-2xl rounded-tl-none shadow-sm border border-gray-100 flex items-center gap-3">
                    <div class="dot-flashing ml-3"></div>
                </div>
            `;
      chatBox.appendChild(loaderDiv);
      const scrollContainer = document.getElementById("scroll-container");
      if (scrollContainer) scrollContainer.scrollTop = scrollContainer.scrollHeight;

      try {
        const response = await fetch("/chat-api/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken(),
          },
          body: JSON.stringify({
            prompt,
            conversation_id: currentConversationId,
            is_genz_mode: isGenZMode
          }),
        });


        if (response.status === 429) {
          document.getElementById(loaderId).remove();
          appendMessage("‚ö†Ô∏è **Daily Limit Reached**: The free AI model has reached its daily specific limit on OpenRouter. Please try again tomorrow or add credits to continue.", 'therapist');
          return;
        }

        const data = await response.json();

        if (data.error) {
          console.error("Backend Error:", data.error, data.details);
          throw new Error(data.error);
        }

        if (data.conversation_id && !currentConversationId) {
          currentConversationId = data.conversation_id;
          loadConversations(); // refresh list to show new title
        }
        document.getElementById(loaderId).remove();
        appendMessage(data.response, 'therapist');
        return data.response; // Return text for voice mode to use

      } catch (error) {
        console.error("Error:", error);
        document.getElementById(loaderId).remove();
        appendMessage("Sorry, I'm having trouble connecting right now.", 'therapist');
        return "Sorry, I'm having trouble connecting right now.";
      }
    }

    // Wrap appendMessage to handle potential double-calls safely or logic separation
    function appendMessage(text, sender) {
      const chatBox = document.getElementById("chat-box");
      const startMessage = document.getElementById("start-message");
      if (startMessage) startMessage.style.display = "none";

      if (sender === 'therapist') {
        const msgDiv = document.createElement("div");
        msgDiv.className = `flex justify-start mb-4 message-enter`;
        msgDiv.innerHTML = `
                <div class="bg-white text-gray-800 rounded-tl-none border border-gray-100 shadow-sm p-4 rounded-2xl max-w-[85%] lg:max-w-[75%] leading-relaxed shadow-md text-sm md:text-base">
                    ${text}
                </div>
            `;
        chatBox.appendChild(msgDiv);
      } else {
        const msgDiv = document.createElement("div");
        msgDiv.className = `flex justify-end mb-4 message-enter`;
        msgDiv.innerHTML = `
                <div class="bg-indigo-600 text-white rounded-tr-none p-4 rounded-2xl max-w-[85%] lg:max-w-[75%] leading-relaxed shadow-md text-sm md:text-base">
                    ${text}
                </div>
            `;
        chatBox.appendChild(msgDiv);
      }

      const scrollContainer = document.getElementById("scroll-container");
      if (scrollContainer) scrollContainer.scrollTop = scrollContainer.scrollHeight;
    }


    // --- Quick Mic (Text Mode) ---
    const micBtn = document.getElementById("mic-btn");
    micBtn.addEventListener("click", () => {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = "en-US";
      recognition.interimResults = false;
      micBtn.classList.add('text-red-500', 'animate-pulse');

      recognition.onresult = function (event) {
        const transcript = event.results[0][0].transcript;
        const input = document.getElementById("user-prompt");
        input.value = transcript;
        input.focus();
        micBtn.classList.remove('text-red-500', 'animate-pulse');
      };
      recognition.onerror = function () { micBtn.classList.remove('text-red-500', 'animate-pulse'); };
      recognition.onend = function () { micBtn.classList.remove('text-red-500', 'animate-pulse'); }
      recognition.start();
    });


    // --- Fully Immersive Voice Mode ---
    const talkBtn = document.getElementById("talk-btn"); // Entry button
    const closeVoiceBtn = document.getElementById("close-voice-btn");
    const muteBtn = document.getElementById("mute-btn");
    const muteIcon = document.getElementById("mute-icon");

    const voiceOverlay = document.getElementById("voice-overlay");
    const mainContent = document.getElementById("main-content");
    const orb = document.getElementById("orb");
    const voiceStatus = document.getElementById("voice-status");
    const voiceSubtext = document.getElementById("voice-subtext");

    let voiceRecognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    voiceRecognition.lang = "en-US";
    voiceRecognition.interimResults = false;
    voiceRecognition.maxAlternatives = 1;
    voiceRecognition.continuous = true;

    let isVoiceModeActive = false;
    let isProcessingVoice = false;
    let isMuted = false;
    let audioPlayer = null;

    // Open Voice Mode
    talkBtn.addEventListener("click", () => {
      isVoiceModeActive = true;
      isMuted = false;

      // UI Transitions
      voiceOverlay.classList.remove("hidden");
      // force reflow
      void voiceOverlay.offsetWidth;
      voiceOverlay.classList.remove("opacity-0", "pointer-events-none");

      // Reset Orb
      updateOrbState("listening");

      // Start Recognition
      try {
        voiceRecognition.start();
      } catch (e) { console.log(e); }
    });

    // Close Voice Mode
    closeVoiceBtn.addEventListener("click", () => {
      isVoiceModeActive = false;

      // Stop Everything
      voiceRecognition.stop();
      if (window.speechSynthesis) window.speechSynthesis.cancel();
      if (audioPlayer) { audioPlayer.pause(); audioPlayer = null; }

      // UI Transitions
      voiceOverlay.classList.add("opacity-0", "pointer-events-none");

      setTimeout(() => {
        voiceOverlay.classList.add("hidden");
      }, 500);
    });

    // Mute Logic
    muteBtn.addEventListener("click", () => {
      if (isMuted) {
        // Unmute
        isMuted = false;
        muteIcon.classList.remove("fa-microphone-slash");
        muteIcon.classList.add("fa-microphone");
        muteBtn.classList.remove("text-red-500", "bg-red-50");
        muteBtn.classList.add("text-gray-600", "bg-white");
        try { voiceRecognition.start(); } catch (e) { }
        updateOrbState("listening");
      } else {
        // Mute / Stop Listening specifically
        isMuted = true;
        voiceRecognition.stop();
        if (audioPlayer) audioPlayer.pause(); // Also stop speaking if muted? Maybe just stop listening.

        muteIcon.classList.remove("fa-microphone");
        muteIcon.classList.add("fa-microphone-slash");
        muteBtn.classList.add("text-red-500", "bg-red-50");
        muteBtn.classList.remove("text-gray-600", "bg-white");
        updateOrbState("idle");
      }
    });

    // Voice Recognition Logic
    voiceRecognition.onresult = async (event) => {
      if (isProcessingVoice || !isVoiceModeActive || isMuted) return;

      const userSpeech = event.results[event.results.length - 1][0].transcript;
      if (!userSpeech.trim()) return;

      isProcessingVoice = true;
      voiceRecognition.stop(); // STOP listening so we don't hear ourselves
      updateOrbState("processing");

      // Use the existing sendMessage function but hijacking it for Voice Mode
      // We need to bypass the default appendMessage behavior if we want custom UI updates?
      // Actually, updating the chat history in background is EXACTLY what we want.

      // 1. Send to Backend (and update background chat)
      // We'll manually append message first to background to be safe
      const chatBox = document.getElementById("chat-box");
      const loaderId = 'loader-' + Date.now();
      // Append user msg to background chat
      appendMessage(userSpeech, 'user');

      // Show loader in background (optional, user can't see it but good for logic)
      // ... (omitted for brevity, sendMessage handles backend call)

      try {
        // We use a direct fetch here to control the flow better than reusing sendMessage
        // actually, reusing code is better. 
        // We will refactor sendMessage slightly to RETURN the text response.

        // ... Wait, I can't easily refactor sendMessage without breaking existing flow.
        // I'll just copy the fetch logic for safety and clarity.

        const response = await fetch("/chat-api/", {
          method: "POST",
          headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() },
          body: JSON.stringify({
            prompt: userSpeech,
            conversation_id: currentConversationId,
            is_genz_mode: isGenZMode
          }),
        });
        const data = await response.json();

        if (data.conversation_id && !currentConversationId) {
          currentConversationId = data.conversation_id;
          loadConversations();
        }

        // Update background chat with AI response
        appendMessage(data.response, 'therapist');

        // 2. Switching to Speaking State
        updateOrbState("speaking");

        // 3. TTS
        // Clean text for TTS (remove [VIDEO: ...] and newlines)
        let ttsText = data.raw_message || data.response;
        // Remove video tags [VIDEO: url]
        ttsText = ttsText.replace(/\[VIDEO:.*?\]/g, "");
        // Remove simple bold markdown if any residue
        ttsText = ttsText.replace(/\*\*/g, "");

        const ttsResponse = await fetch("/tts/", {
          method: "POST",
          headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() },
          body: JSON.stringify({ text: ttsText }),
        });

        if (ttsResponse.ok) {
          const blob = await ttsResponse.blob();
          const audioUrl = URL.createObjectURL(blob);
          audioPlayer = new Audio(audioUrl);

          audioPlayer.onended = () => {
            isProcessingVoice = false;
            if (isVoiceModeActive && !isMuted) {
              updateOrbState("listening");
              try { voiceRecognition.start(); } catch (e) { }
            }
          };

          audioPlayer.play();
        } else {
          throw new Error("TTS Failed");
        }

      } catch (error) {
        console.error(error);
        isProcessingVoice = false;
        updateOrbState("listening"); // Reset to listening on error
      }
    };

    voiceRecognition.onend = () => {
      if (isVoiceModeActive && !isMuted && !isProcessingVoice) {
        try {
          voiceRecognition.start();
        } catch (e) { console.log("Restarting recog..."); }
      }
    };

    voiceRecognition.onerror = (e) => {
      console.log("Voice Error", e.error);
      if (e.error === 'no-speech') return;
      if (isVoiceModeActive && !isProcessingVoice) updateOrbState("listening");
    };

    function updateOrbState(state) {
      // states: idle, listening, processing, speaking
      orb.className = "orb"; // reset

      if (state === "listening") {
        orb.classList.add("listening");
        voiceStatus.innerText = "Soluna is listening...";
        voiceSubtext.innerText = "Go ahead, I'm all ears.";
      } else if (state === "processing") {
        orb.classList.add("processing");
        voiceStatus.innerText = "Thinking...";
        voiceSubtext.innerText = "Processing your thoughts...";
      } else if (state === "speaking") {
        orb.classList.add("speaking");
        voiceStatus.innerText = "Soluna is speaking...";
        voiceSubtext.innerText = "Listen to the response.";
      } else {
        // idle
        voiceStatus.innerText = "Paused";
        voiceSubtext.innerText = "Tap the mic to resume.";
      }
    }


    // --- Logout ---
    document.getElementById("logout-btn").addEventListener("click", async () => {
      if (!confirm("Are you sure you want to logout?")) return;
      await fetch("/logout/", {
        method: "POST",
        headers: { "X-CSRFToken": getCSRFToken() },
      });
      window.location.href = "/login/";
    });

  </script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(function (registration) {
          console.log('Service Worker registered with scope:', registration.scope);
        })
        .catch(function (error) {
          console.log('Service Worker registration failed:', error);
        });
    }
  </script>
</body>

</html>